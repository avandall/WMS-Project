flowchart TD
    Start([Client Request]) --> RateLimit{Rate Limit<br/>Check}
    RateLimit -->|Exceeded| Reject429[429 Too Many Requests]
    RateLimit -->|OK| ReqID[Generate Request ID]
    
    ReqID --> CORS{CORS<br/>Check}
    CORS -->|Blocked| Reject403[403 Forbidden]
    CORS -->|OK| Router[Route to Handler]
    
    Router --> ValidateInput{Validate<br/>Input}
    ValidateInput -->|Invalid| Reject400[400 Bad Request]
    ValidateInput -->|Valid| GetSession[Get DB Session]
    
    GetSession --> CreateService[Create Service<br/>with Dependencies]
    CreateService --> ExecuteLogic[Execute Business Logic]
    
    ExecuteLogic --> CheckTx{Requires<br/>Transaction?}
    
    CheckTx -->|No| DirectExec[Execute Directly]
    CheckTx -->|Yes| StartTx[Start Transaction]
    
    StartTx --> DisableCommit[Disable Auto-Commit]
    DisableCommit --> MultiOps[Execute Multiple<br/>Operations]
    
    MultiOps --> AllOpsOK{All<br/>Successful?}
    AllOpsOK -->|Yes| Commit[Commit Transaction]
    AllOpsOK -->|No| Rollback[Rollback Transaction]
    
    Rollback --> LogError[Log Error]
    LogError --> Reject500[500 Internal Error]
    
    DirectExec --> Response
    Commit --> EnableCommit[Re-enable Auto-Commit]
    EnableCommit --> Response[Return Response]
    
    Response --> AddHeaders[Add Headers<br/>X-Request-ID]
    AddHeaders --> LogSuccess[Log Success]
    LogSuccess --> End([200 OK Response])
    
    Reject429 --> End
    Reject403 --> End
    Reject400 --> End
    Reject500 --> End
    
    style Start fill:#4CAF50,stroke:#2E7D32,color:#fff
    style End fill:#4CAF50,stroke:#2E7D32,color:#fff
    style Reject429 fill:#F44336,stroke:#B71C1C,color:#fff
    style Reject403 fill:#F44336,stroke:#B71C1C,color:#fff
    style Reject400 fill:#F44336,stroke:#B71C1C,color:#fff
    style Reject500 fill:#F44336,stroke:#B71C1C,color:#fff
    style StartTx fill:#2196F3,stroke:#1565C0,color:#fff
    style Commit fill:#4CAF50,stroke:#2E7D32,color:#fff
    style Rollback fill:#FF9800,stroke:#E65100,color:#fff
